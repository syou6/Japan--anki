<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知テスト</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        button:hover {
            background: #2563eb;
        }
        .log {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            background: #fee;
            color: #c00;
        }
        .success {
            background: #efe;
            color: #060;
        }
    </style>
</head>
<body>
    <h1>通知デバッグツール</h1>
    
    <button onclick="testEdgeFunction()">Edge Function テスト</button>
    <button onclick="checkSubscription()">サブスクリプション確認</button>
    <button onclick="checkFamily()">家族関係確認</button>
    
    <div id="logs"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const supabaseUrl = 'https://dtcskayvcsrgjausqkni.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0Y3NrYXl2Y3NyZ2phdXNxa25pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1OTc2MTMsImV4cCI6MjA3MTE3MzYxM30.QwcXKKEnCKkXKd7gVbHbU2K356zRvYMEOJ7xOujh93c';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.insertBefore(logEntry, logsDiv.firstChild);
        }
        
        window.testEdgeFunction = async function() {
            try {
                log('Edge Function を呼び出しています...');
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('ログインしてください', 'error');
                    return;
                }
                
                const response = await supabase.functions.invoke('send-push-notification', {
                    body: {
                        userId: user.id,
                        title: 'テスト通知',
                        body: 'Edge Functionからのテスト通知です',
                        type: 'family_diary',
                        data: {
                            url: 'https://ai-voce-journal.vercel.app'
                        }
                    }
                });
                
                if (response.error) {
                    log(`エラー: ${JSON.stringify(response.error)}`, 'error');
                } else {
                    log(`成功: ${JSON.stringify(response.data)}`, 'success');
                }
            } catch (error) {
                log(`例外エラー: ${error.message}`, 'error');
            }
        };
        
        window.checkSubscription = async function() {
            try {
                log('サブスクリプションを確認中...');
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('ログインしてください', 'error');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('push_subscriptions')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (error) {
                    log(`サブスクリプションなし: ${error.message}`, 'error');
                } else {
                    log(`サブスクリプション: ${JSON.stringify(data, null, 2)}`, 'success');
                }
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
            }
        };
        
        window.checkFamily = async function() {
            try {
                log('家族関係を確認中...');
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('ログインしてください', 'error');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('family_relationships')
                    .select('*')
                    .or(`parent_id.eq.${user.id},child_id.eq.${user.id}`)
                    .eq('status', 'accepted');
                
                if (error) {
                    log(`エラー: ${error.message}`, 'error');
                } else if (!data || data.length === 0) {
                    log('家族関係なし', 'error');
                } else {
                    log(`家族関係: ${JSON.stringify(data, null, 2)}`, 'success');
                }
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>